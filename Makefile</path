# Makefile - Camel OS v0.4 Professional
# 3-Component Architecture: MBR, System, Installer

CC = gcc
AS = nasm
LD = ld

# Flags
CFLAGS = -m32 -fno-stack-protector -fno-builtin -nostdinc -O2 -Icommon -fno-pic -fno-pie -mregparm=3 -fomit-frame-pointer -ffreestanding
# Note: We REMOVED LDFLAGS here because we specify them per target now

# --- 1. BOOTLOADER (MBR) ---
mbr.bin: boot/mbr.asm
	$(AS) -f bin boot/mbr.asm -o mbr.bin
	@echo "âœ“ MBR bootloader built"

# --- 2. TARGET SYSTEM (For the HDD) ---
# Uses system_entry.asm + linker_system.ld + system_main()
system/entry.o: boot/system_entry.asm
	$(AS) -f elf32 boot/system_entry.asm -o system/entry.o

# Include common directory (which includes fs subdirectory), but exclude duplicate drivers
SYS_SRC = system/kernel.c $(wildcard common/*.c) $(wildcard common/fs/*.c) \
          drivers/keyboard.c drivers/mouse.c drivers/sound.c drivers/vga.c \
          kernel/shell.c
SYS_OBJ = $(SYS_SRC:.c=.o) system/entry.o

system.elf: $(SYS_OBJ)
	$(LD) -m elf_i386 -T linker_system.ld -o system.elf $(SYS_OBJ)
	@echo "âœ“ Target system (system.elf) built"

system.bin: system.elf
	objcopy -O binary system.elf system.bin
	@echo "âœ“ Target system binary extracted"

# --- 3. INSTALLER (For the ISO/USB) ---
# Uses multiboot.asm + linker_installer.ld + main()
INST_SRC = installer/installer_main.c $(wildcard common/*.c) $(wildcard common/fs/*.c) \
           drivers/mouse.c drivers/sound.c drivers/vga.c
INST_OBJ = $(INST_SRC:.c=.o) installer/payload.o installer/entry.o

installer/entry.o: boot/multiboot.asm
	$(AS) -f elf32 boot/multiboot.asm -o installer/entry.o

installer/payload.o: installer/payload.asm system.bin mbr.bin
	$(AS) -f elf32 installer/payload.asm -o installer/payload.o

installer.bin: $(INST_OBJ)
	# Important: Use linker_installer.ld to enforce Multiboot header location
	$(LD) -m elf_i386 -T linker_installer.ld -o installer.bin $(INST_OBJ)
	@echo "âœ“ Installer (installer.bin) built with embedded payloads"

# --- 4. ISO GENERATION ---
camel_install.iso: installer.bin
	mkdir -p iso/boot/grub
	cp installer.bin iso/boot/
	printf 'set timeout=0\nmenuentry "Camel OS Installer" {\n  multiboot /boot/installer.bin\n  boot\n}' > iso/boot/grub/grub.cfg
	grub-mkrescue -o camel_install.iso iso
	rm -rf iso
	@echo "âœ“ Installation ISO created: camel_install.iso"

# --- 5. DISK IMAGE ---
disk.img:
	dd if=/dev/zero of=disk.img bs=1M count=100 2>/dev/null
	@echo "âœ“ Disk image created: disk.img (100MB)"

# --- BUILD ALL COMPONENTS ---
all: mbr.bin system.bin installer.bin camel_install.iso disk.img
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘        CAMEL OS v0.4 PROFESSIONAL - BUILD COMPLETE     â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“ Generated Files:"
	@echo "   â”œâ”€ mbr.bin           (Hard Drive Bootloader)"
	@echo "   â”œâ”€ system.bin        (Target Operating System)"
	@echo "   â”œâ”€ installer.bin     (Installation Tool)"
	@echo "   â”œâ”€ camel_install.iso (Bootable Installation Media)"
	@echo "   â””â”€ disk.img          (Installation Target - 100MB)"
	@echo ""
	@echo "ğŸš€ Installation Process:"
	@echo "   1. make install     â†’ Boot installer from ISO/USB"
	@echo "   2. make run         â†’ Boot installed system from disk"
	@echo "   3. make clean       â†’ Remove all build artifacts"

# --- COMMANDS ---

# Installation mode: Boots the ISO that performs the installation
# This simulates real-world USB installation
install: camel_install.iso disk.img
	@echo "ğŸ”§ Starting Camel OS Installer..."
	@echo "   ğŸ“€ Installation Media: camel_install.iso"
	@echo "   ğŸ’¾ Target Disk: disk.img (100MB)"
	@echo ""
	@echo "ğŸ’¡ Tip: To test real USB installation, flash camel_install.iso to USB:"
	@echo "   sudo dd if=camel_install.iso of=/dev/sdX bs=4M status=progress"
	@echo ""
	# Installer runs from CD/ISO (-cdrom), simulates USB
	qemu-system-x86_64 -cdrom camel_install.iso -hda disk.img -serial stdio

# Production mode: Boot directly from the installed hard disk
run: disk.img
	@echo "ğŸš€ Starting Camel OS (Installed Version)..."
	@echo "   ğŸ’¾ Boot Device: disk.img"
	@echo ""
	@echo "ğŸ’¡ This simulates booting from the installed hard drive"
	@echo "   after running the installer."
	@echo ""
	# Production run from HDD (-hda)
	qemu-system-x86_64 -hda disk.img -serial stdio

# Development mode: Test individual components
test-system: system.elf
	@echo "ğŸ§ª Testing Target System (standalone)..."
	@echo "   ğŸ“„ File: system.elf"
	@echo ""
	qemu-system-x86_64 -kernel system.elf -serial stdio

test-installer: installer.bin
	@echo "ğŸ§ª Testing Installer (standalone)..."
	@echo "   ğŸ“„ File: installer.bin"
	@echo ""
	qemu-system-x86_64 -kernel installer.bin -serial stdio

# Compilation rules
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -f *.o *.bin *.iso
	rm -f common/*.o system/*.o installer/*.o boot/*.o drivers/*.o kernel/*.o
	rm -f system/entry.o installer/entry.o installer/payload.o
	rm -rf iso
	rm -f disk.img mbr.bin
	@echo "âœ“ Clean complete"

# Print build information
info:
	@echo "ğŸ”§ Camel OS v0.4 Professional Build System"
	@echo "=========================================="
	@echo ""
	@echo "ğŸ“ Project Structure:"
	@echo "   â”œâ”€â”€ boot/          (Bootloaders)"
	@echo "   â”œâ”€â”€ common/        (Shared drivers)"
	@echo "   â”œâ”€â”€ system/        (Target OS)"
	@echo "   â”œâ”€â”€ installer/     (Installation tool)"
	@echo "   â””â”€â”€ Makefile       (Build system)"
	@echo ""
	@echo "ğŸ—ï¸  Build Components:"
	@echo "   â€¢ MBR bootloader (512 bytes) â†’ mbr.bin"
	@echo "   â€¢ Target system (installed OS) â†’ system.bin"
	@echo "   â€¢ Professional installer â†’ installer.bin"
	@echo "   â€¢ Bootable ISO â†’ camel_install.iso"
	@echo ""
	@echo "ğŸš€ Key Features:"
	@echo "   â€¢ Serial debugging output"
	@echo "   â€¢ ATA device detection"
	@echo "   â€¢ Professional installer with drive selection"
	@echo "   â€¢ Professional panic screen with register dumps"
	@echo "   â€¢ USB bootable installation media"
